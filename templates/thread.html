<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/board.css') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <title>Ï€chan - /{{ thread.board.id }}</title>
</head>
<body class="chan-bg vh-100 d-flex flex-column align-items-center">
    <nav class="chan-nav d-flex w-100 border-bottom py-1" style="height: fit-content;">
        <ul class="d-flex gap-2 w-100 px-2 list-unstyled m-0" style="height: fit-content; width: max-content;">
            {% for board in boards %}
                <a href="{{ url_for('Admin.Board' if api_key else 'Boards.Board', id=board.id, **({'api_key': api_key} if api_key else {})) }}" title="{{ board.name }}" style="font-size: 0.8rem; font-family: 'Courier New'; height: fit-content;">/{{ board.id }}</a>
            {% endfor %}
        </ul>
        <a href="{{ url_for('Admin.home' if api_key else 'Index.home', **({'api_key': api_key} if api_key else {})) }}" class="px-2" style="font-size: 0.8rem; font-family: 'Courier New'; height: fit-content;">Home</a>
    </nav>
    <main class="d-flex w-100 flex-column align-items-center" style="height: fit-content;">
        <div class="chan-title d-flex justify-content-between border-bottom border-black fw-bold align-items-center align-content-center gap-3 w-100 px-3 bg-dark" style="background: linear-gradient(to right, #1827209c, transparent); margin-bottom: 1rem;">
            <div class="d-flex align-items-center align-content-center justify-content-start gap-3">
                <p class="text-success m-0 text-ellipsis">/{{ thread.board.id }}</p>
                <p class="m-0" style="height: fit-content; font-size: 2.5rem;">-</p>
                <p class="m-0" style="height: fit-content; font-size: 2.5rem;">{{ thread.board.name }}: </p>
                <p class="m-0 px-1 text-white text-ellipsis fw-light fst-italic font-monospace" style="height: fit-content; font-size: 1.2rem; background-color: rgba(0, 0, 0, 0.2); margin-top: 0.5rem !important;">Thread No.{{ thread.id }}</p>
            </div>
            <p class="text-white-50 text-ellipsis m-0" style="font-size: 0.7rem;">{{ thread.board.description }}</p>
        </div>

        <!-- New reply modal -->
        <div class="modal fade" id="newReply" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog" data-bs-theme="dark">
                <div class="modal-content chan-thread-modal">
                    <div class="modal-header" style="border-color: #5e5e5e;">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Reply data:</h1>
                    <button type="button" class="btn-close"  data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form class="d-flex flex-column gap-2" action="" method="post">
                            <textarea class="w-100" placeholder="Content" id="reply_content"></textarea>
                            <input type="hidden" name="new_reply_type" value="{{ 1 if api_key else 0 }}" id="new_reply_type" required>
                            <input type="file" name="" accept=".jpg,.png" id="image-r" >

                            <input type="hidden" id="thread_or_reply_id" value="">
                        </form>
                    </div>
                    <div class="modal-footer" style="border-color: #5e5e5e;">
                    <button type="button" class="btn btn-secondary chan-button-close w-100" style="max-width: 80px;" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary chan-button w-100" style="max-width: 150px;" onclick="postReply()">Post reply</button>
                    </div>
                </div>
            </div>
        </div>
  
        <hr class="border-white w-100 my-0">
            
            <div class="d-flex w-100 px-2 py-1 align-items-start">
                <a href="{{ url_for('Admin.Board' if api_key else 'Boards.Board', id=thread.board.id, **({'api_key': api_key} if api_key else {})) }}" title="{{ thread.board.name }}" style="font-size: 0.8rem; font-family: 'Courier New'; height: fit-content;">Back to /{{ thread.board.id }}</a>
            </div>

        <hr class="border-white w-100 my-0" style="margin-bottom: 1.1rem !important;">
  
        <!-- Rendering Threads and Replies -->
        <section class="d-flex flex-column overflow- align-items-start w-100 px-3 gap-3" style="padding-bottom: 1rem; height: fit-content;" id="threads">
            
            {% macro render_replies(replies, level, thread) %}

                {% for reply in replies %}
                        
                    <div id="r{{ reply.id }}" class="chan-{{ 'admin-' if reply.type == 1 }}thread-info d-flex flex-column" style="min-width: 300px; margin-left: {{ 20 * level }}px; width: fit-content;">
                        <div class="d-flex justify-content-start align-content-start gap-1">
                            <div class="d-flex gap-1 align-items-center justify-content-start m-0 text-ellipsis" style="font-size: 0.7rem; color: rgba(255, 255, 255, 0.700);">
                                <span class="m-0" style="font-size: 0.7rem; {{ 'color: rgba(255, 255, 255, 0.700);' if reply.type == 0 else 'color: rgba(0, 255, 136);' }}">
                                    {{ 'Admin:' if reply.type == 1 else 'User:' }}
                                </span>
                                <span class="m-0 text-ellipsis" style="font-size: 0.7rem; color: rgba(255, 255, 255, 0.700);">
                                    {{ reply.user_token }}
                                </span>
                                {% if reply.user_token == thread.user_token %}
                                    <span class="text-info m-0 text-ellipsis" style="font-size: 0.7rem;">(OP)</span>
                                {% endif %}
                                {% if reply.type == 1 %}
                                    <img style="width: 15px; height: 15px;" src="{{ url_for('static', filename='pi.svg') }}" alt="">
                                {% endif %}
                            </div>
                            
                            <hr class="m-0" style="width: 1px; border-left: solid 1px;">
                            <p class="m-0 text-ellipsis" style="font-size: 11px; color: rgba(255, 255, 255, 0.700);">Reply No.{{ reply.id }}</p>
                            <hr class="m-0" style="width: 1px; border-left: solid 1px;">
                            <a
                                onclick="highlightPost({{ 'r' ~ (reply.reply.id | string) if reply.reply else 't' ~ (reply.thread.id | string) }})"
                                href="#{{ 'r' ~ (reply.reply.id | string) if reply.reply else 't' ~ (reply.thread.id | string) }}"
                                class="m-0 text-ellipsis" style="font-size: 11px; color: rgba(0, 255, 166, 0.7);">
                                Replying to: {{ 'r-' ~ (reply.reply.id | string) if reply.reply else 't-' ~ (reply.thread.id | string)}}
                            </a>
                        </div>

                        <p class="m-0" style="font-size: 13px; color: rgba(255, 255, 255, 0.900); min-height: {{'1.5rem' if reply.image else '2.5rem'}};">{{ reply.content }}</p>
                        {% if reply.image %}
                            <div class="d-flex flex-column justify-content-center" style="width: 30%;">
                                <img class="rounded-1" style="width: 100%; height: auto; max-height: 400px;" src="{{ url_for('Images.Image', id=reply.image.id) }}" alt="">
                                <div class="d-flex gap-1">
                                    <p style="font-size: 0.7rem; color: #696969;" class="m-0">File: </p>
                                    <a style="font-size: 0.7rem;" class="m-0 text-ellipsis" href="{{ url_for('Images.Image', id=reply.image.id) }}">{{ reply.image.name }}</a>
                                </div>
                                <p style="font-size: 0.7rem; color: #696969;" class="m-0 p-0">({{ (reply.image.size|int / 1024)|int }}KB {{ reply.image.measures }})</p>                    
                            </div>
                        {% endif %}
                        <div class="d-flex justify-content-between">
                            <div class="d-flex gap-1">
                                <p class="m-0" style="font-size: 11px; color: rgba(255, 255, 255, 0.700);">
                                    {{ '%02d' | format(reply.date.day) }}/{{ '%02d' | format(reply.date.month) }}/{{ reply.date.year }}
                                </p>
                                <hr class="m-0 h-100" style="width: 1px; border-left: solid 1px;">
                                <p class="m-0" style="font-size: 11px; color: rgba(255, 255, 255, 0.700);">{{ reply.time }}</p>
                                <p class="m-0" style="font-size: 11px; color: rgba(255, 255, 255, 0.700);">UTC</p>
                            </div>

                            <div class="d-flex justify-content-center gap-1">
                                <button onclick="submitVote(1, {{ reply.id }}, 'r')" title="{{ reply.votes|selectattr('up_or_down', 'equalto', 1)|list|length }}" class="d-flex p-0 border-0 bg-transparent text-white" style="height: fit-content;">
                                    <i class="fa-solid fa-caret-up px-1" id="1r{{ reply.id }}" style="font-size: 0.9rem; padding-top: 0.15rem; background-color: rgba(0, 153, 255, 0.2); border-radius: 3px; height: fit-content;"></i>
                                </button>
                                <button onclick="submitVote(0, {{ reply.id }}, 'r')" title="{{ reply.votes|selectattr('up_or_down', 'equalto', 0)|list|length }}" class="d-flex p-0 border-0 bg-transparent text-white" style="height: fit-content;">
                                    <i class="fa-solid fa-caret-down px-1" id="0r{{ reply.id }}" style="font-size: 0.9rem; padding-bottom: 0.15rem; background-color: rgba(255, 78, 78, 0.2); border-radius: 3px; height: fit-content;"></i>
                                </button>
                                <button class="d-flex gap-1 align-items-center text-white p-0 border-0 px-1" style="background-color: rgba(0, 255, 89, 0.1); border-radius: 3px;" onclick="replyModal('r{{ reply.id }}')" type="button" data-bs-toggle="modal" data-bs-target="#newReply">
                                    <i style="font-size: 0.7rem;" class="fa-solid fa-reply"></i>
                                    <p style="font-size: 0.7rem;" class="m-0">Reply</p>   
                                </button>
                                {% if api_key %}
                                    <button onclick="deletePost({{ reply.id }}, 'r')" class="d-flex gap-1 align-items-center text-white p-0 border-0 px-1" style="background-color: rgba(243, 35, 35, 0.2); border-radius: 3px;" type="button">
                                        <i style="font-size: 0.7rem;" class="fa-solid fa-eraser"></i>
                                        <p style="font-size: 0.7rem;" class="m-0">Delete</p>   
                                    </button>
                                {% endif %}
                            </div>
                        </div>

                    </div>
                    
                    <!-- Render nested replies recursively with updated level -->
                    {% if reply.reply_replies %}
                        
                        {{ render_replies(reply.reply_replies, level + 1, thread) }}
                        
                    {% endif %}
                      

                {% endfor %}

            {% endmacro %}


            {% if thread.type == 1 %}
                <div class="d-flex gap-1">
                    {% if thread.image %}
                        <div class="d-flex flex-column justify-content-start" style="max-width: 235px; max-height: fit-content;">
                            <img class="rounded-1 shadow img-fluid" src="{{ url_for('Images.Image', id=thread.image.id) }}" >
                            <div class="d-flex gap-1">
                                <p style="font-size: 0.7rem; color: #696969;" class="m-0">File: </p>
                                <a style="font-size: 0.7rem;" class="m-0 text-ellipsis" href="{{ url_for('Images.Image', id=thread.image.id) }}">{{ thread.image.name }}</a>
                            </div>
                            <p style="font-size: 0.7rem; color: #696969;" class="m-0 p-0">({{ (thread.image.size|int / 1024)|int }}KB {{ thread.image.measures }})</p>                    
                        </div>
                    {% endif %}
                    <div class="d-flex flex-column gap-1 w-100">
                        
                        <div id="t{{ thread.id }}" class="chan-admin-thread-info border-info-subtle" style="min-width: 350px; width: fit-content;">
                            <div class="d-flex gap-2">
                                <a class="chan-thread-title text-ellipsis m-0 text-decoration-none fst-italic" href="{{ url_for('Admin.Thread' if api_key else 'Threads.Thread', id=thread.id, **({'api_key': api_key} if api_key else {})) }}" style="font-weight: 500; text;">{{ thread.title }}</a>
                                <div class="d-flex flex-column justify-content-around">
                                    <div class="d-flex align-items-center gap-1">
                                        <p class="m-0" style="font-size: 0.7rem; color: rgba(0, 255, 136);">Admin:</p>
                                        <p class="m-0 text-ellipsis" style="font-size: 0.7rem !important; color: rgba(255, 255, 255, 0.700);">{{ thread.user_token }}</p>
                                        <img style="width: 15px; height: 15px;" src="{{ url_for('static', filename='pi.svg') }}" alt="">
                                    </div>
                                    <p class="m-0 text-ellipsis" style="font-size: 0.7rem; color: rgba(255, 255, 255, 0.700);">Thread No.{{ thread.id }}</p>      
                                </div>
                            </div>

                            <p class="chan-text-content">{{ thread.content }}</p>

                            <div class="d-flex justify-content-between">
                                <div class="d-flex gap-1">
                                    <p class="m-0" style="font-size: 0.7rem; color: rgba(255, 255, 255, 0.700);">
                                        {{ '%02d' | format(thread.date.day) }}/{{ '%02d' | format(thread.date.month) }}/{{ thread.date.year }}
                                    </p>
                                    <hr class="m-0 h-100" style="width: 1px; border-left: solid 1px;">
                                    <p class="m-0" style="font-size: 0.7rem; color: rgba(255, 255, 255, 0.700);">{{ thread.time }}</p>
                                    <p class="m-0" style="font-size: 0.7rem; color: rgba(255, 255, 255, 0.700);">UTC</p>    
                                </div>
                                <div class="d-flex justify-content-center gap-1">
                                    <button onclick="submitVote(1, {{ thread.id }}, 't')"                                    title="{{ thread.votes|selectattr('up_or_down', 'equalto', 1)|list|length }}" class="d-flex p-0 border-0 bg-transparent text-white" style="height: fit-content;">
                                        <i class="fa-solid fa-caret-up px-1" id="1t{{ thread.id }}" style="font-size: 0.9rem; padding-top: 0.15rem; background-color: rgba(0, 153, 255, 0.2); border-radius: 3px; height: fit-content;"></i>
                                    </button>
                                    <button onclick="submitVote(0, {{ thread.id }}, 't')" title="{{ thread.votes|selectattr('up_or_down', 'equalto', 0)|list|length }}" class="d-flex p-0 border-0 bg-transparent text-white" style="height: fit-content;">
                                        <i class="fa-solid fa-caret-down px-1" id="0t{{ thread.id }}" style="font-size: 0.9rem; padding-bottom: 0.15rem; background-color: rgba(255, 78, 78, 0.2); border-radius: 3px; height: fit-content;"></i>
                                    </button>
                                    <button class="d-flex gap-1 align-items-center text-white p-0 border-0 px-1" style="background-color: rgba(0, 255, 89, 0.1); border-radius: 3px;" onclick="replyModal('t{{ thread.id }}')" type="button" data-bs-toggle="modal" data-bs-target="#newReply">
                                        <i style="font-size: 0.7rem;" class="fa-solid fa-reply"></i>
                                        <p style="font-size: 0.7rem;" class="m-0">Reply</p>   
                                    </button>
                                    {% if api_key %}
                                        <button onclick="deletePost({{ thread.id }}, 't')" class="d-flex gap-1 align-items-center text-white p-0 border-0 px-1" style="background-color: rgba(243, 35, 35, 0.2); border-radius: 3px;" type="button">
                                            <i style="font-size: 0.7rem;" class="fa-solid fa-eraser"></i>
                                            <p style="font-size: 0.7rem;" class="m-0">Delete</p>   
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {{ render_replies(thread.replies, 2, thread) }}    
                    </div>    
                </div>
            {% else %}
                <div class="d-flex gap-1">
                    {% if thread.image %}
                        <div class="d-flex flex-column justify-content-start" style="max-width: 235px; max-height: fit-content;">
                            <img class="rounded-1 shadow img-fluid" src="{{ url_for('Images.Image', id=thread.image.id) }}" >
                            <div class="d-flex gap-1">
                                <p style="font-size: 0.7rem; color: #696969;" class="m-0">File: </p>
                                <a style="font-size: 0.7rem;" class="m-0 text-ellipsis" href="{{ url_for('Images.Image', id=thread.image.id) }}">{{ thread.image.name }}</a>
                            </div>
                            <p style="font-size: 0.7rem; color: #696969;" class="m-0 p-0">({{ (thread.image.size|int / 1024)|int }}KB {{ thread.image.measures }})</p>                    
                        </div>
                    {% endif %}
                    <div class="d-flex flex-column gap-1 w-100">
                        
                        <div id="t{{ thread.id }}" class="chan-thread-info border-info-subtle" style="min-width: 350px; width: fit-content;">
                            <div class="d-flex gap-2">
                                <a class="chan-thread-title text-ellipsis m-0 text-decoration-none fst-italic" href="{{ url_for('Admin.Thread' if api_key else 'Threads.Thread', id=thread.id, **({'api_key': api_key} if api_key else {})) }}" style="font-weight: 500; text;">{{ thread.title }}</a>
                                <div class="d-flex flex-column justify-content-around">
                                    <p class="m-0 text-ellipsis" style="font-size: 0.7rem; color: rgba(255, 255, 255, 0.700);">User: {{ thread.user_token }}</p>
                                    <p class="m-0 text-ellipsis" style="font-size: 0.7rem; color: rgba(255, 255, 255, 0.700);">Thread No.{{ thread.id }}</p>      
                                </div>
                            </div>

                            <p class="chan-text-content">{{ thread.content }}</p>

                            <div class="d-flex justify-content-between">
                                <div class="d-flex gap-1">
                                    <p class="m-0" style="font-size: 0.7rem; color: rgba(255, 255, 255, 0.700);">
                                        {{ '%02d' | format(thread.date.day) }}/{{ '%02d' | format(thread.date.month) }}/{{ thread.date.year }}
                                    </p>
                                    <hr class="m-0 h-100" style="width: 1px; border-left: solid 1px;">
                                    <p class="m-0" style="font-size: 0.7rem; color: rgba(255, 255, 255, 0.700);">{{ thread.time }}</p>
                                    <p class="m-0" style="font-size: 0.7rem; color: rgba(255, 255, 255, 0.700);">UTC</p>    
                                </div>
                                <div class="d-flex justify-content-center gap-1">
                                    <button onclick="submitVote(1, {{ thread.id }}, 't')"                                    title="{{ thread.votes|selectattr('up_or_down', 'equalto', 1)|list|length }}" class="d-flex p-0 border-0 bg-transparent text-white" style="height: fit-content;">
                                        <i class="fa-solid fa-caret-up px-1" id="1t{{ thread.id }}" style="font-size: 0.9rem; padding-top: 0.15rem; background-color: rgba(0, 153, 255, 0.2); border-radius: 3px; height: fit-content;"></i>
                                    </button>
                                    <button onclick="submitVote(0, {{ thread.id }}, 't')" title="{{ thread.votes|selectattr('up_or_down', 'equalto', 0)|list|length }}" class="d-flex p-0 border-0 bg-transparent text-white" style="height: fit-content;">
                                        <i class="fa-solid fa-caret-down px-1" id="0t{{ thread.id }}" style="font-size: 0.9rem; padding-bottom: 0.15rem; background-color: rgba(255, 78, 78, 0.2); border-radius: 3px; height: fit-content;"></i>
                                    </button>
                                    <button class="d-flex gap-1 align-items-center text-white p-0 border-0 px-1" style="background-color: rgba(0, 255, 89, 0.1); border-radius: 3px;" onclick="replyModal('t{{ thread.id }}')" type="button" data-bs-toggle="modal" data-bs-target="#newReply">
                                        <i style="font-size: 0.7rem;" class="fa-solid fa-reply"></i>
                                        <p style="font-size: 0.7rem;" class="m-0">Reply</p>   
                                    </button>
                                    {% if api_key %}
                                        <button onclick="deletePost({{ thread.id }}, 't')" class="d-flex gap-1 align-items-center text-white p-0 border-0 px-1" style="background-color: rgba(243, 35, 35, 0.2); border-radius: 3px;" type="button">
                                            <i style="font-size: 0.7rem;" class="fa-solid fa-eraser"></i>
                                            <p style="font-size: 0.7rem;" class="m-0">Delete</p>   
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {{ render_replies(thread.replies, 2, thread) }}    
                    </div>    
                </div>
            {% endif %}
            


        </section>

    </main>

    <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="{{ url_for('static', filename='js/board.js') }}"></script>
    {% if api_key %}
        <script>
            async function deletePost(id, post_type){
                
                const currentUrl = window.location.href;
                const url = new URL(currentUrl);
                const params = new URLSearchParams(url.search);
                const apiKey = params.get('api_key')

                const response = await fetch(`/${post_type == 't' ? 'thread' : 'reply'}/${id}?api_key=${apiKey}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const responseData = await response.json();

                location.reload()
                
            }
        </script>
    {% endif %}
</body>
</html>