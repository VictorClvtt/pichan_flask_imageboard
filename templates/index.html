<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <title>πchan{{ ' - Admin' if api_key}}</title>
</head>
<body class="chan-bg d-flex flex-column align-items-center" style="height: fit-content;">
    
    <main class="d-flex px-3 w-100 flex-column align-items-center py-3" style="height: fit-content;">
        <div class="d-flex flex-column align-content-center justify-content-center align-items-center" style="min-height: 100px; margin-bottom: 0.5rem;">
            <h1 class="chan-title d-flex m-0"><p class="text-success fst-italic m-0">π</p>chan</h1>
            {% if api_key %}
                <p class="text-white font-monospace m-0" style="letter-spacing: 2px;">Administrator</p>
            {% endif %}    
        </div>
        
        <h2 class="d-flex align-items-center fst-italic text-white w-100 m-0" style="max-width: 800px; font-size: 15px; font-family: 'Courier New', Courier, monospace; white-space: nowrap;">Boards:<hr class="border-white w-100 my-0 mx-1" style="height: fit-content; margin-bottom: 1px !important;"></h2>
        <section class="chan-index-section" id="boards">
            {% for board_group in board_groups %}
                <div class="d-flex flex-column" id="{{ board_group.id }}">
                    <h3 class="chan-title text-decoration-underline m-0 px-1" style="font-size: 17px; width: fit-content; background-color: rgba(0, 0, 0, 0.25);">{{ board_group.name }}:</h3>
                    
                    {% for board in board_group.boards %}
                        <a 
                            style="font-size: 15px;" 
                            class="mx-1" 
                            href="{{ url_for('Admin.Board' if api_key else 'Boards.Board', id=board.id, **({'api_key': api_key} if api_key else {})) }}">
                            /{{ board.id + ' - ' + board.name }}
                        </a>
                    {% endfor %}

                    
                </div>
            {% endfor %}
        </section>

        {% if api_key %}
            <div class="d-flex gap-1 w-100" style="max-width: 800px; margin-top: 0.2rem;">
                <button class="w-100 chan-admin-button" type="button" data-bs-toggle="modal" data-bs-target="#newBoardGroup">+ New Board Group</button>
                <button class="w-100 chan-admin-button" type="button" data-bs-toggle="modal" data-bs-target="#newBoard">+ New Board</button>
            </div>
            <div class="d-flex gap-1 w-100" style="max-width: 800px; margin-top: 0.3rem;">
                <button class="w-100 chan-admin-button" type="button" data-bs-toggle="modal" data-bs-target="#deleteBoardGroup">- Delete Board Group</button>
                <button class="w-100 chan-admin-button" type="button" data-bs-toggle="modal" data-bs-target="#deleteBoard">- Delete Board</button>
            </div>

            <!-- New Board Group Modal -->
            <div class="modal fade" id="newBoardGroup" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog" data-bs-theme="dark">
                    <div class="modal-content chan-admin-modal">
                        <div class="modal-header" style="border-color: #5e5e5e;">
                        <h1 class="modal-title fs-5" id="exampleModalLabel">Board Group data:</h1>
                        <button type="button" class="btn-close"  data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form class="d-flex flex-column gap-2" action="" method="post">
                                
                                <input type="text" placeholder="New board group name" id="new_board_group_name">
                                <input type="text" placeholder="API KEY" id="new_board_group_api_key">
    
                            </form>
                        </div>
                        <div class="modal-footer" style="border-color: #5e5e5e;">
                            <button type="button" class=" chan-admin-button w-100" style="max-width: 80px;" data-bs-dismiss="modal">Close</button>
                            <button type="button" class=" chan-admin-button w-100" style="max-width: 200px;" onclick="newBoardGroup()">Create Board Group</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Delete Board Group Modal -->
            <div class="modal fade" id="deleteBoardGroup" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog" data-bs-theme="dark">
                    <div class="modal-content chan-admin-modal">
                        <div class="modal-header" style="border-color: #5e5e5e;">
                        <h1 class="modal-title fs-5" id="exampleModalLabel">Board Group data:</h1>
                        <button type="button" class="btn-close"  data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form class="d-flex flex-column gap-2" action="" method="POST">
                                
                                <select id="delete_board_group_id">
                                        <option value="" hidden selected disabled >Board Group</option>
                                    {% for board_group in board_groups %}
                                        <option value="{{ board_group.id }}">{{ board_group.name }}</option>
                                    {% endfor %}
                                </select>
                                <input type="text" placeholder="API KEY" id="delete_board_group_api_key">
    
                            </form>
                        </div>
                        <div class="modal-footer" style="border-color: #5e5e5e;">
                            <button type="button" class=" chan-admin-button w-100" style="max-width: 80px;" data-bs-dismiss="modal">Close</button>
                            <button type="button" class=" chan-admin-button w-100" style="max-width: 200px;" onclick="deleteBoardGroup()">Delete Board Group</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- New Board Modal -->
            <div class="modal fade" id="newBoard" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog" data-bs-theme="dark">
                    <div class="modal-content chan-admin-modal">
                        <div class="modal-header" style="border-color: #5e5e5e;">
                        <h1 class="modal-title fs-5" id="exampleModalLabel">Board data:</h1>
                        <button type="button" class="btn-close"  data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form class="d-flex flex-column gap-2" action="" method="POST">
                                
                                <select id="board_group_id">
                                        <option value="" hidden selected disabled>Board Group</option>
                                    {% for board_group in board_groups %}
                                        <option value="{{ board_group.id }}">{{ board_group.name }}</option>
                                    {% endfor %}
                                </select>
                                <input type="text" placeholder="New board name" id="new_board_name_id">
                                <input type="text" placeholder="New board id(/x)" id="new_board_id_id">
                                <input type="text" placeholder="New board description" id="new_board_desc_id">
                                <input type="text" placeholder="API KEY" id="new_board_api_key">
    
                            </form>
                        </div>
                        <div class="modal-footer" style="border-color: #5e5e5e;">
                            <button type="button" class=" chan-admin-button w-100" style="max-width: 80px;" data-bs-dismiss="modal">Close</button>
                            <button type="button" class=" chan-admin-button w-100" style="max-width: 200px;" onclick="newBoard()">Create Board</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Delete Board Modal -->
            <div class="modal fade" id="deleteBoard" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog" data-bs-theme="dark">
                    <div class="modal-content chan-admin-modal">
                        <div class="modal-header" style="border-color: #5e5e5e;">
                        <h1 class="modal-title fs-5" id="exampleModalLabel">Board data:</h1>
                        <button type="button" class="btn-close"  data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form class="d-flex flex-column gap-2" action="" method="POST">
                                
                                <select id="delete_board_id">
                                        <option value="" hidden selected disabled>Board</option>
                                    {% for board in boards %}
                                        <option value="{{ board.id }}">{{ board.name }}</option>
                                    {% endfor %}
                                </select>
                            
                                <input type="text" placeholder="API KEY" id="delete_board_api_key">
    
                            </form>
                        </div>
                        <div class="modal-footer" style="border-color: #5e5e5e;">
                            <button type="button" class=" chan-admin-button w-100" style="max-width: 80px;" data-bs-dismiss="modal">Close</button>
                            <button type="button" class=" chan-admin-button w-100" style="max-width: 200px;" onclick="deleteBoard()">Create Board</button>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}

        <h2 class="d-flex align-items-center fst-italic text-white w-100 m-0 mt-4" style="max-width: 800px; font-size: 15px; font-family: 'Courier New', Courier, monospace; white-space: nowrap;">Popular Threads:<hr class="border-white w-100 my-0 mx-1" style="height: fit-content; margin-bottom: 1px !important;"></h2>
        <section class="chan-index-section admin-button" id="popular-threads">
            <div class="chan-threads-container">
                {% for board in boards %}
                    
                    {% if loop.index <= 12 %}
        
                        {% set ns = namespace(most_voted_thread = None, max_votes = 0) %}
        
                        {% for thread in board.threads %}
                            {% set total_votes = thread.votes.all() | length %}
                            
                            {% if total_votes > ns.max_votes %}
                                {% set ns.most_voted_thread = thread %}
                                {% set ns.max_votes = total_votes %}
                            {% endif %}
                        {% endfor %}
        
                        {% if ns.most_voted_thread %}
                            <div class="d-flex flex-column align-items-center" style="max-width: 175px; max-height: 275px;">
                                <a href="{{ url_for('Admin.Board' if api_key else 'Boards.Board', id=ns.most_voted_thread.board.id, **({'api_key': api_key} if api_key else {})) }}" class="chan-title text-decoration-underline fw-bold m-0 py-1" style="font-size: 0.9rem;">{{ board.name }}</a>
                                <a href="{{ url_for('Admin.Thread' if api_key else 'Threads.Thread', id=ns.most_voted_thread.id, **({'api_key': api_key} if api_key else {})) }}" title="{{ ns.most_voted_thread.title }}">
                                    <img style="max-width: 150px; max-height: 150px; border: 1px solid rgb(66, 212, 144); background: rgba(0, 255, 234, 0.05);" src="{{ url_for('Images.Image', id=ns.most_voted_thread.image.id) }}" alt="">
                                </a>
                                <p class="ellipsis-multiline text-white">
                                    {{ ns.most_voted_thread.content }}
                                </p>
                            </div>
                        {% endif %}

                    {% endif %}    
                    
                {% endfor %}
            </div>
        </section>
        

        <h2 class="d-flex align-items-center text-white w-100 m-0 mt-4" style="max-width: 800px; font-size: 15px; font-family: 'Courier New', Courier, monospace; white-space: nowrap;">Statistics:<hr class="border-white w-100 my-0 mx-1" style="height: fit-content; margin-bottom: 1px !important;"></h2>
        <section class="chan-index-section flex-wrap align-items-center justify-content-around py-3" id="statistics">
            <div class="d-flex gap-1 text-white fw-bold px-1" style="background-color: rgba(0, 0, 0, 0.25);">Total Threads: <p class="fw-normal m-0">{{ threads|length }}</p></div>
            <div class="d-flex gap-1 text-white fw-bold px-1" style="background-color: rgba(0, 0, 0, 0.25);">Total Replies: <p class="fw-normal m-0">{{ replies|length }}</p></div>
            <div class="d-flex gap-1 text-white fw-bold px-1" style="background-color: rgba(0, 0, 0, 0.25);">Active Content: <p class="fw-normal m-0">{{ ((images | map(attribute='size') | sum) / 1024)|int }} KB</p></div>
        </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    {% if api_key %}
        <script>

            document.getElementById('board_group_id').value = ''
            document.getElementById('new_board_id_id').value = ''
            document.getElementById('new_board_name_id').value = ''
            document.getElementById('new_board_desc_id').value = ''
            document.getElementById('new_board_group_api_key').value = ''

            document.getElementById('new_board_group_name').value = ''
            document.getElementById('new_board_api_key').value = ''

            document.getElementById('delete_board_group_id').value = ''
            document.getElementById('delete_board_group_api_key').value = ''

            document.getElementById('delete_board_id').value = ''
            document.getElementById('delete_board_api_key').value = ''

            async function newBoardGroup(){

                newBoardGroupData = {
                    name: document.getElementById('new_board_group_name').value
                }

                const apiKey = document.getElementById('new_board_group_api_key').value
                const response = await fetch(`/board_group?api_key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(newBoardGroupData),
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const responseData = await response.json();

                location.reload()
            }

            async function deleteBoardGroup(){

                
                id = document.getElementById('delete_board_group_id').value
                

                const apiKey = document.getElementById('delete_board_group_api_key').value
                const response = await fetch(`/board_group/${id}?api_key=${apiKey}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const responseData = await response.json();

                location.reload()
            }

            async function newBoard() {
                // Gather form data
                const newBoardData = {
                    id: document.getElementById('new_board_id_id').value,
                    name: document.getElementById('new_board_name_id').value,
                    description: document.getElementById('new_board_desc_id').value,
                    board_group_id: document.getElementById('board_group_id').value
                };

                // Get the API key from the form input
                const apiKey = document.getElementById('new_board_api_key').value;

                try {
                    // Make the POST request
                    const response = await fetch(`/board?api_key=${apiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(newBoardData),
                    });

                    // If the response is not ok (status not 2xx), throw an error
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`Server error: ${response.status} - ${errorData.message}`);
                    }

                    // Parse the response body if the request was successful
                    const responseData = await response.json();

                    // Optional: Log the response data for debugging
                    console.log('Board created successfully:', responseData);

                    // Reload the page after success
                    location.reload();
                } catch (error) {
                    // Log the error message for debugging
                    console.error('Error creating board:', error.message);
                }
            }

            async function deleteBoard(){

                
                id = document.getElementById('delete_board_id').value


                const apiKey = document.getElementById('delete_board_api_key').value
                const response = await fetch(`/board/${id}?api_key=${apiKey}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const responseData = await response.json();

                location.reload()
            }
        </script>
    {% endif %}    

</body>
</html>